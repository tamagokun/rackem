#!/usr/bin/env php
<?php

if(!class_exists("\\Rackem\Server"))
{
	try {
		require_once dirname(__DIR__).'/rackem.php';
	}catch(Exception $e)
	{
		echo "Failed to load Rack'em library. Is rackem installed in the proper location?\n";
	}
}

if(function_exists("date_default_timezone_set"))
	date_default_timezone_set('UTC');

$argv = $GLOBALS['argv'];
array_shift($argv);

$flags = array('h','process','ruby','basic');
$args = array();
$opts = array();
while(list($k,$arg) = each($argv))
{
	$opt_regex = '/-{1,2}(\w*)(=.*)?/';
	if(preg_match($opt_regex,$arg,$m) !== 1)
	{
		$args[] = $arg;
		continue;
	}
	$opts[$m[1]] = true;
	if(!empty($m[2]))
	{
		$opts[$m[1]] = ltrim($m[2],'=');
		continue;
	}
	if(in_array($m[1],$flags)) continue;
	if(($next = current($argv)) === false) continue;
	if(preg_match($opt_regex,$next) === 1) continue;
	$opts[$m[1]] = $next;
	each($argv);
}

$app = count($args) > 0? $args[0] : 'config.php';

if(isset($opts['basic']))
{
	$app = "\\Rackem\\BasicWebServer";
}else if(!file_exists($app))
{
	echo "configuration {$app} not found\n";
	exit(1);
}

$host = isset($opts['host'])? $opts['host'] : '0.0.0.0';
$port = isset($opts['port'])? $opts['port'] : '9393';
$client = isset($opts['client'])? $opts['client'] : false;

$server = new \Rackem\Server($host, $port, $app);
if(isset($opts['process']) && $opts['process'])
	echo $server->process(stream_get_contents(fopen("php://stdin","r")), $client);
else
	$server->start();
